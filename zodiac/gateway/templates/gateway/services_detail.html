{% extends "gateway/base.html" %}

{% block h1_title %}
  {{object.name}}
  <small>{% include 'gateway/active_label.html' with status=object.is_active %}</small>
  {% if object.is_private %}<small><span class="label label-warning">Private</span></small>{% endif %}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="box box-primary">
      <div class="box-header with-border">
    		<h2 class="box-title">Service Details</h2>
      </div>
      <div class="box-body">
        <dl>
          <dt>Description</dt>
          <dd>{{object.description}}</dd>
          <dt>Routes</dt>
          <dd><code>{{object.method}}</code> requests for <code>api/{{object.external_uri}}</code> will be sent to <code>{{object.service_route}}</code></dd>
          {% if object.post_service or object.callback_service %}<dt>Callbacks</dt>{% endif %}
          <dd>
            {% if object.post_service %}
            <p>Delivers <code>{{object.post_service.method}}</code> request to <a href="{{object.post_service.get_absolute_url}}">{{object.post_service}}</a></p>
            {% endif %}
            {% if object.callback_service %}
            <p>Queues <code>{{object.callback_service.method}}</code> request for <a href="{{object.callback_service.get_absolute_url}}">{{object.callback_service}}</a></p>
            {% endif %}
          </dd>
          <dt>Application</dt>
          <dd><a href="{{object.application.get_absolute_url}}">{{object.application.name}}</a></dd>
          <dt>Authentication</dt>
          <dd>{{object.get_plugin_display}}</dd>
          {% if object.sources %}
          <dt>Sources</dt>
          {% for source in object.sources.all %}<dd>User <code>{{source.user.username}}</code> identified by API Key <code>{{source.apikey}}</code></dd>{% endfor %}
          {% endif %}
        </dl>
      </div>
      <div class="box-footer">
        <a href="{{ object.get_update_url }}" class="btn btn-primary">Edit Service</a>
        <a href="{% url 'services-delete' pk=object.pk %}" class="btn btn-danger">Delete Service</a>
        <a href="#" id="trigger-service-btn" class="btn btn-success pull-right">Manually Trigger</a>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="box box-primary">
      <div class="box-header with-border">
    		<h2 class="box-title">Recent Results</h2>
      </div>
      <div class="box-body">
        {% if service_results %}
        <table class="table table-striped">
          <thead>
            <th>Identifier</th>
            <th>Result</th>
            <th>Date</th>
          </thead>
          <tbody>
            {% for result in service_results %}
              <tr>
                <td><a href="{% url 'results-detail' pk=result.id %}">{{ result.async_result_id }}</a></td>
                <td style="width:60%"><pre>{{result.task_result.result}}</pre></td>
                <td>{{result.task_result.date_done}}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No results for this service.</p>
        {% endif %}
      </div>
      <div class="box-footer text-center">
        <a href="{% url 'results-list' %}" class="btn btn-default">View all results</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
  var trigger_url = '{{ object.get_trigger_url }}'
  $(document).ready(function(){
    $('#trigger-service-btn').click(function(){
      $.get(trigger_url,{}, function(resp){
        if(resp.SUCCESS == 1){
          displayMessage('success', "Service successfully triggered.")
        }
        else {
          displayMessage('danger', "There was a problem triggering this service.")
        }
      });
    })

    retrieve_objects_async_results();
  });

  function displayMessage(type, message) {
    iconClass = 'check'
    if (type == 'danger') {
      iconClass = 'times'
    }
    $('#messages').empty()
    $('#messages').append(
      '<div class="row">\
      	<div class="col-md-12">\
          <div class="alert alert-'+type+' alert-dismissible">\
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>\
              <i class="icon fa fa-'+iconClass+'"></i>'+message+'\
          </div>\
        </div>\
      </div>').fadeIn(300);
      setTimeout(function(){
  			$('#messages').fadeOut(1300);
  		}, 8000);
  }
</script>
{% endblock %}
